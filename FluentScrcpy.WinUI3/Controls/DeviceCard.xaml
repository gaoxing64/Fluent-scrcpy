<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Name="DeviceCardRoot"
    x:Class="FluentScrcpy.WinUI3.Controls.DeviceCard"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:FluentScrcpy.WinUI3.Controls"
    xmlns:models="using:FluentScrcpy.WinUI3.Models">

    <UserControl.Resources>
        <!-- Card Reveal Style -->
        <Style x:Key="CardRevealStyle" TargetType="Border">
            <Setter Property="Background" Value="{ThemeResource CardBackgroundFillColorDefaultBrush}"/>
            <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
        </Style>

        <!-- Reveal Button Style with rounded corners -->
        <Style x:Key="ActionButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{ThemeResource ButtonBackground}"/>
            <Setter Property="Foreground" Value="{ThemeResource ButtonForeground}"/>
            <Setter Property="BorderBrush" Value="{ThemeResource ButtonBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Grid x:Name="RootGrid">
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup x:Name="CommonStates">
                                    <VisualState x:Name="Normal">
                                        <Storyboard>
                                            <PointerUpThemeAnimation Storyboard.TargetName="RootGrid"/>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="PointerOver">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="BackgroundBorder" Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource ButtonBackgroundPointerOver}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="BackgroundBorder" Storyboard.TargetProperty="BorderBrush">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource ButtonBorderBrushPointerOver}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource ButtonForegroundPointerOver}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                            <PointerUpThemeAnimation Storyboard.TargetName="RootGrid"/>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="Pressed">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="BackgroundBorder" Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource ButtonBackgroundPressed}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="BackgroundBorder" Storyboard.TargetProperty="BorderBrush">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource ButtonBorderBrushPressed}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource ButtonForegroundPressed}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                            <PointerDownThemeAnimation Storyboard.TargetName="RootGrid"/>
                                        </Storyboard>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                            <Border
                                x:Name="BackgroundBorder"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                                <ContentPresenter
                                    x:Name="ContentPresenter"
                                    Content="{TemplateBinding Content}"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"/>
                            </Border>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Accent Action Button Style -->
        <Style x:Key="AccentActionButtonStyle" TargetType="Button" BasedOn="{StaticResource ActionButtonStyle}">
            <Setter Property="Background" Value="{ThemeResource AccentButtonBackground}"/>
            <Setter Property="Foreground" Value="{ThemeResource AccentButtonForeground}"/>
            <Setter Property="BorderBrush" Value="{ThemeResource AccentButtonBorderBrush}"/>
        </Style>

        <!-- Toggle Button Reveal Style with rounded corners -->
        <Style x:Key="ToggleRevealStyle" TargetType="ToggleButton">
            <Setter Property="Background" Value="{ThemeResource ToggleButtonBackground}"/>
            <Setter Property="Foreground" Value="{ThemeResource ToggleButtonForeground}"/>
            <Setter Property="BorderBrush" Value="{ThemeResource ToggleButtonBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Grid x:Name="RootGrid">
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup x:Name="CommonStates">
                                    <VisualState x:Name="Normal">
                                        <Storyboard>
                                            <PointerUpThemeAnimation Storyboard.TargetName="RootGrid"/>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="PointerOver">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="BackgroundBorder" Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource ToggleButtonBackgroundPointerOver}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="BackgroundBorder" Storyboard.TargetProperty="BorderBrush">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource ToggleButtonBorderBrushPointerOver}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                            <PointerUpThemeAnimation Storyboard.TargetName="RootGrid"/>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="Pressed">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="BackgroundBorder" Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource ToggleButtonBackgroundPressed}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="BackgroundBorder" Storyboard.TargetProperty="BorderBrush">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource ToggleButtonBorderBrushPressed}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                            <PointerDownThemeAnimation Storyboard.TargetName="RootGrid"/>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="Checked">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="BackgroundBorder" Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentButtonBackground}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="BackgroundBorder" Storyboard.TargetProperty="BorderBrush">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentButtonBorderBrush}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentButtonForeground}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="CheckedPointerOver">
                                        <Storyboard>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="BackgroundBorder" Storyboard.TargetProperty="Background">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentButtonBackgroundPointerOver}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="BackgroundBorder" Storyboard.TargetProperty="BorderBrush">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentButtonBorderBrushPointerOver}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource AccentButtonForeground}"/>
                                            </ObjectAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                            <Border
                                x:Name="BackgroundBorder"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                                <ContentPresenter
                                    x:Name="ContentPresenter"
                                    Content="{TemplateBinding Content}"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"/>
                            </Border>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <Border Style="{StaticResource CardRevealStyle}">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Device Info Header -->
            <Grid Grid.Row="0" Margin="0,0,0,16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Device Icon -->
                <Border
                    Grid.Column="0"
                    Width="48"
                    Height="48"
                    CornerRadius="8"
                    Background="{ThemeResource AccentFillColorDefaultBrush}"
                    Margin="0,0,16,0">
                    <FontIcon
                        Glyph="&#xE8A3;"
                        FontSize="24"
                        Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"/>
                </Border>

                <!-- Device Details - Fixed binding to use direct property binding -->
                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                    <TextBlock
                        x:Name="ModelTextBlock"
                        Text="{Binding Model, FallbackValue='未知设备'}"
                        Style="{StaticResource SubtitleTextBlockStyle}"
                        FontWeight="SemiBold"/>
                    <TextBlock
                        x:Name="SerialTextBlock"
                        Text="{Binding Serial, FallbackValue='未知序列号'}"
                        Style="{StaticResource CaptionTextBlockStyle}"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,4,0,0">
                        <TextBlock
                            x:Name="IpTextBlock"
                            Text="{Binding IpAddress}"
                            Style="{StaticResource CaptionTextBlockStyle}"
                            Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                            Visibility="{Binding IpAddress, Converter={StaticResource StringNotEmptyToVisibilityConverter}}"/>
                        <Border
                            Background="{ThemeResource AccentFillColorDefaultBrush}"
                            CornerRadius="4"
                            Padding="6,2,6,2"
                            Visibility="{Binding IsWireless, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <TextBlock
                                Text="无线"
                                Style="{StaticResource CaptionTextBlockStyle}"
                                Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"
                                FontSize="10"/>
                        </Border>
                    </StackPanel>
                </StackPanel>
            </Grid>

            <!-- Main Actions -->
            <Grid Grid.Row="1" Margin="0,0,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Start Mirroring Button -->
                <Button
                    x:Name="StartButton"
                    Grid.Column="0"
                    Content="开始投屏"
                    Command="{Binding StartMirroringCommand, ElementName=DeviceCardRoot}"
                    CommandParameter="{Binding}"
                    HorizontalAlignment="Stretch"
                    Height="40"
                    Style="{StaticResource AccentActionButtonStyle}"/>

                <!-- Stop Mirroring Button -->
                <Button
                    x:Name="StopButton"
                    Grid.Column="0"
                    Content="停止投屏"
                    Click="StopMirroringButton_Click"
                    HorizontalAlignment="Stretch"
                    Height="40"
                    Style="{StaticResource AccentActionButtonStyle}"
                    Visibility="Collapsed"/>

                <Button
                    Grid.Column="1"
                    Content="无线连接"
                    Command="{Binding SwitchToWirelessCommand, ElementName=DeviceCardRoot}"
                    CommandParameter="{Binding}"
                    Margin="8,0,0,0"
                    Height="40"
                    Style="{StaticResource ActionButtonStyle}"
                    Visibility="{Binding IsWireless, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>

                <Button
                    Grid.Column="2"
                    Content="设备配置"
                    Command="{Binding OpenConfigCommand, ElementName=DeviceCardRoot}"
                    CommandParameter="{Binding}"
                    Margin="8,0,0,0"
                    Height="40"
                    Style="{StaticResource ActionButtonStyle}"/>
            </Grid>

            <!-- Quick Controls (Visible when mirroring) -->
            <Grid x:Name="QuickControlsGrid" Grid.Row="2" Margin="0,4,0,0" Visibility="Collapsed">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Window Controls - Stretch layout -->
                <Grid Grid.Row="0" Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <ToggleButton
                        Grid.Column="0"
                        ToolTipService.ToolTip="全屏 (Alt+F)"
                        Checked="FullscreenToggle_Checked"
                        Unchecked="FullscreenToggle_Unchecked"
                        Margin="0,0,4,0"
                        HorizontalAlignment="Stretch"
                        Style="{StaticResource ToggleRevealStyle}">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <FontIcon Glyph="&#xE740;" FontSize="14"/>
                            <TextBlock Text="全屏" FontSize="12"/>
                        </StackPanel>
                    </ToggleButton>

                    <ToggleButton
                        Grid.Column="1"
                        ToolTipService.ToolTip="置顶 (Alt+T)"
                        Checked="AlwaysOnTopToggle_Checked"
                        Unchecked="AlwaysOnTopToggle_Unchecked"
                        Margin="4,0,4,0"
                        HorizontalAlignment="Stretch"
                        Style="{StaticResource ToggleRevealStyle}">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <FontIcon Glyph="&#xE840;" FontSize="14"/>
                            <TextBlock Text="置顶" FontSize="12"/>
                        </StackPanel>
                    </ToggleButton>

                    <ToggleButton
                        Grid.Column="2"
                        ToolTipService.ToolTip="无边框 (Alt+X)"
                        Checked="BorderlessToggle_Checked"
                        Unchecked="BorderlessToggle_Unchecked"
                        Margin="4,0,4,0"
                        HorizontalAlignment="Stretch"
                        Style="{StaticResource ToggleRevealStyle}">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <FontIcon Glyph="&#xE8A5;" FontSize="14"/>
                            <TextBlock Text="无边框" FontSize="12"/>
                        </StackPanel>
                    </ToggleButton>

                    <Button
                        Grid.Column="3"
                        ToolTipService.ToolTip="聚焦窗口"
                        Click="FocusWindowButton_Click"
                        Margin="4,0,0,0"
                        HorizontalAlignment="Stretch"
                        Style="{StaticResource ActionButtonStyle}">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <FontIcon Glyph="&#xE7C4;" FontSize="14"/>
                            <TextBlock Text="聚焦" FontSize="12"/>
                        </StackPanel>
                    </Button>
                </Grid>

                <!-- Device Control Buttons - Stretch layout -->
                <Grid Grid.Row="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Button
                        Grid.Column="0"
                        ToolTipService.ToolTip="Home 键"
                        Click="HomeButton_Click"
                        Margin="0,0,4,0"
                        HorizontalAlignment="Stretch"
                        Style="{StaticResource ActionButtonStyle}">
                        <FontIcon Glyph="&#xE80F;" FontSize="16"/>
                    </Button>

                    <Button
                        Grid.Column="1"
                        ToolTipService.ToolTip="最近任务"
                        Click="RecentsButton_Click"
                        Margin="4,0,4,0"
                        HorizontalAlignment="Stretch"
                        Style="{StaticResource ActionButtonStyle}">
                        <FontIcon Glyph="&#xE81C;" FontSize="16"/>
                    </Button>

                    <Button
                        Grid.Column="2"
                        ToolTipService.ToolTip="返回键"
                        Click="BackButton_Click"
                        Margin="4,0,4,0"
                        HorizontalAlignment="Stretch"
                        Style="{StaticResource ActionButtonStyle}">
                        <FontIcon Glyph="&#xE72B;" FontSize="16"/>
                    </Button>

                    <Button
                        Grid.Column="3"
                        ToolTipService.ToolTip="静音"
                        Click="MuteButton_Click"
                        Margin="4,0,4,0"
                        HorizontalAlignment="Stretch"
                        Style="{StaticResource ActionButtonStyle}">
                        <FontIcon Glyph="&#xE74F;" FontSize="16"/>
                    </Button>

                    <Button
                        Grid.Column="4"
                        ToolTipService.ToolTip="电源键"
                        Click="PowerButton_Click"
                        Margin="4,0,0,0"
                        HorizontalAlignment="Stretch"
                        Style="{StaticResource ActionButtonStyle}">
                        <FontIcon Glyph="&#xE7E8;" FontSize="16"/>
                    </Button>
                </Grid>
            </Grid>
        </Grid>
    </Border>
</UserControl>
